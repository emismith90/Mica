(function ($) {
    $.fn.getFormData = function () {
        var data = {};
        var dataArray = $(this).serializeArray();
        for (var i = 0; i < dataArray.length; i++) {
            data[dataArray[i].name] = dataArray[i].value;
        }

        return data;
    };

    $.fn.attrs = function (attrs) {
        var t = $(this);
        if (attrs) {
            // Set attributes
            t.each(function (i, e) {
                var j = $(e);
                for (var attr in attrs) {
                    j.attr(attr, attrs[attr]);
                }
            });
            return t;
        } else {
            // Get attributes
            var a = {},
                r = t.get(0);
            if (r) {
                r = r.attributes;
                for (var i in r) {
                    var p = r[i];
                    if (typeof p.nodeValue !== 'undefined') a[p.nodeName] = p.nodeValue;
                }
            }
            return a;
        }
    };
})(jQuery);
Mica = {};

Mica.Common = {};
Mica.Common.SmartLink = {
    bindEvent: function ($scope) {
        if (!$scope)
            $scope = $(document);

        var $links = $('a[sr-to]', $scope);

        // clickable look & feel
        $links.each(function (index, element) {
            element.href = 'javascript:void(0);';
        });

        $links.click(function () {
            var $link = $(this);
            var canRedirect = $link.attr('sr-can-redirect');
            if (canRedirect && canRedirect !== "True") return;

            var target = $link.attr('sr-to');

            var attrs = $link.attrs();

            var localQueryString = {};
            Object.keys(attrs).forEach(function (attr) {
                if (attr.startsWith('sr-route')) {
                    localQueryString[attr.substring(9)] = $link.attr(attr);
                }
            });

            var currentQueryString = Mica.Utils.QueryString.getObject();
            $.extend(currentQueryString, localQueryString);

            window.location.href = target + Mica.Utils.QueryString.serialize(currentQueryString);
        });
    }
};
Mica.Utils = {};
Mica.Utils.QueryString = {
    getObject: function () {
        var vars = {};
        if (window.location.href.indexOf('?') < 0) return {};

        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
            var hash = hashes[i].split('=');
            vars[hash[0]] = hash[1];
        }
        return vars;
    },

    serialize: function (obj) {
        var str = [];
        for (var p in obj)
            if (obj.hasOwnProperty(p)) {
                str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
            }

        if (str.length > 0) {
            return '?' + str.join('&');
        }

        return null;
    }
}

$(document).ready(function () {
    Mica.Common.SmartLink.bindEvent();
});
(function ($) {
    $.fn.registerAsDeleteModal = function () {
        var $modal = $(this);
        var $form = $('#delete-material', $modal);

        $('.js-delete--material').click(function () {
            if (!$form.valid()) return;

            $.ajax({
                url: '/Material/Delete/',
                data: $form.getFormData(),
                type: 'POST',
                success: function (data) {
                    location.reload();
                }
            });
        });
    }
})(jQuery);
(function ($) {
    $.fn.registerAsEditModal = function () {
        var $modal = $(this);
        var $form = $('#edit-material', $modal);

        $('.js-save--material').click(function () {
            if (!$form.valid()) return;

            $.ajax({
                url: '/Material/Save/',
                data: $form.getFormData(),
                type: 'POST',
                success: function (data) {
                    location.reload();
                }
            });
        });

        $("input[type='checkbox']", $form).on("click", function () {
            if ($(this).prop('checked')) {
                $(this).attr('value', true);
            } else {
                $(this).attr('value', false);
            }
        }); 
    }
})(jQuery);
(function ($) {
    $(document).ready(function () {
        $('.js-open-modal').on('click', function () {
            var contentUrl = $(this).data('modal-content-url');
            var target = $(this).data('target');
            var formType = $(this).data('form-type');

            // clear modal content
            $('.modal-content', target).html('');

            $.ajax({
                url: contentUrl,
                type: 'GET',
                success: function (data) {
                    $('.modal-content', target).html(data);
                    
                    registerFormSubmitEvent(formType, target);
                }
            });
        });
    })

    function registerFormSubmitEvent(formType, modalSelector) {
        var $modal = $(modalSelector);
        switch (formType) {
            case 'add':
            case 'edit':
                $modal.registerAsEditModal();
                break;
            case 'delete':
                $modal.registerAsDeleteModal();
                break;
        }
    }
})(jQuery);